{% extends 'dashboards/base_dashboard.html' %}
{% block dashboard_content %}
<div class="p-4 lg:p-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold">Admin Overview</h2>
    <div class="flex items-center gap-2">
      <a href="{% url 'users:user_list' %}" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Manage Users</a>
      <button id="openCreateUserModal" class="px-3 py-2 bg-indigo-600 text-white rounded text-sm">Create User</button>
      <a href="/admin/" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Open Admin</a>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2 bg-white rounded shadow p-4">
      <h3 class="font-semibold mb-3">Recent Leaves (last 6 months)</h3>
      <div class="w-full h-56">
        <canvas id="leavesChart" class="w-full h-full"></canvas>
      </div>
      {{ chart_months|json_script:"months-data" }}
      {{ chart_counts|json_script:"counts-data" }}
    </div>

    <div class="space-y-4">
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-600">Users</div>
        <div class="text-2xl font-bold">{{ total_users }}</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-600">Total Leaves</div>
        <div class="text-2xl font-bold">{{ total_leaves }}</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-600">Pending</div>
        <div class="text-2xl font-bold">{{ pending_leaves }}</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      try{
        const months = JSON.parse(document.getElementById('months-data').textContent);
        const counts = JSON.parse(document.getElementById('counts-data').textContent);
        const ctx = document.getElementById('leavesChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: { labels: months, datasets: [{ label: 'Leave requests', data: counts, backgroundColor: 'rgba(79, 70, 229, 0.8)' }] },
          options: { responsive:true, maintainAspectRatio:false }
        });
      } catch(e){ console.error(e); }
    })();
  </script>
  <!-- Create User Modal -->
  <div id="createUserModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Create User</h3>
        <button id="closeCreateUserModal" class="text-gray-600">âœ•</button>
      </div>
      <div id="createUserErrors" class="mb-3 text-sm text-red-600"></div>
      <form id="createUserForm">
        {% csrf_token %}
        {{ create_user_form.as_p }}
        <div class="mt-4 flex items-center gap-2">
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Create</button>
          <button type="button" id="cancelCreateUser" class="px-3 py-2 bg-gray-200 rounded">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    (function(){
      const openBtn = document.getElementById('openCreateUserModal');
      const modal = document.getElementById('createUserModal');
      const closeBtn = document.getElementById('closeCreateUserModal');
      const cancelBtn = document.getElementById('cancelCreateUser');
      const form = document.getElementById('createUserForm');
      const errorsBox = document.getElementById('createUserErrors');

      function showModal(){ modal.classList.remove('hidden'); }
      function hideModal(){ modal.classList.add('hidden'); errorsBox.innerHTML = ''; form.reset(); }

      openBtn.addEventListener('click', showModal);
      closeBtn.addEventListener('click', hideModal);
      cancelBtn.addEventListener('click', hideModal);

      form.addEventListener('submit', function(e){
        e.preventDefault();
        errorsBox.innerHTML = '';
        const data = new FormData(form);
        fetch('{% url "users:create_user_ajax" %}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: data
        }).then(r => r.json())
        .then(json => {
          if(json.success){
            // reload to show new user in lists
            window.location.reload();
          } else {
            if(json.errors){
              const parts = [];
              for(const k in json.errors){ parts.push('<strong>'+k+':</strong> '+ json.errors[k].join(', ')); }
              errorsBox.innerHTML = parts.join('<br>');
            } else if (json.error){
              errorsBox.textContent = json.error;
            }
          }
        }).catch(err => {
          errorsBox.textContent = 'Unexpected error';
          console.error(err);
        });
      });
    })();
  </script>
</div>
{% endblock %}
